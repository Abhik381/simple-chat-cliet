<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Chat</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        background: #181818;
        color: #fff;
        font-family: 'Segoe UI', Arial, sans-serif;
        margin: 0;
        min-height: 100vh;
      }
      main {
        max-width: 480px;
        margin: 0 auto;
        background: #222;
        border-radius: 0 0 16px 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.2);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      header {
        padding: 24px 16px 18px 16px;
        background: #24292f;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        font-size: 1.6rem;
        font-weight: 700;
        text-align: center;
        letter-spacing: 1px;
      }
      #searchUser {
        display: flex;
        gap: 8px;
        padding: 16px;
        background: #222;
        border-bottom: 1px solid #333;
      }
      #searchUserInput {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: none;
        font-size: 1rem;
        background: #333;
        color: #fff;
        outline: none;
      }
      #searchUser button {
        padding: 10px 18px;
        border-radius: 8px;
        border: none;
        background: #007bff;
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
      }
      #searchUser button:hover {
        background: #0056b3;
      }
      #searchedUsers {
        flex: 1;
        overflow-y: auto;
        padding: 8px 0 0 0;
      }
      #searchedUsers ul {
        list-style: none;
        padding: 0 16px;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .user {
        background: #333;
        border-radius: 10px;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        transition: background 0.2s;
      }
      .user:hover {
        background: #444;
      }
      .userInfo a {
        color: #fff;
        text-decoration: none;
        font-size: 1.1rem;
        font-weight: 500;
        letter-spacing: 0.5px;
      }
      @media (max-width: 600px) {
        main {
          max-width: 100vw;
          border-radius: 0;
        }
        header {
          border-radius: 0;
        }
        #searchUser {
          padding: 10px;
        }
        #searchedUsers ul {
          padding: 0 6px;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header>Simple Chat</header>
      <section id="searchUser">
        <input type="text" id="searchUserInput" placeholder="Search Name" />
        <button>Search</button>
      </section>
      <section id="searchedUsers">
        <ul></ul>
      </section>
      <div id="popupBox" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
        <div id="popupContent" style="background:#222;padding:32px 24px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.2);max-width:320px;width:90vw;color:#fff;position:relative;">
          <span id="closePopup" style="position:absolute;top:12px;right:16px;font-size:1.5rem;cursor:pointer;">&times;</span>
          <div id="popupUserInfo"></div>
        </div>
      </div>
    </main>
    <script>
      if (!localStorage.getItem("isLoggedIn")) {
        window.location.href = "login.html";
      }

      const searchUserInput = document.getElementById("searchUserInput");
      const searchedUsers = document.getElementById("searchedUsers");
      const userList = searchedUsers.querySelector("ul");

      async function fetchUser(params) {
        try {
          let user = await fetch(
            `http://localhost:3000/api/users/get-user-name/${params}`
          );
          user = await user.json();
          userList.innerHTML = userTemplate(user);
          showPopup(user);
        } catch (error) {
          console.error("Error fetching users:", error);
        }
      }

      function showPopup(user) {
        
        const popupBox = document.getElementById('popupBox');
        const popupUserInfo = document.getElementById('popupUserInfo');
        popupUserInfo.innerHTML = `
          <h2 style='margin-bottom:16px;'>User Info</h2>
          <p><strong>Name:</strong> ${user.name}</p>
          <p><strong>Country:</strong> ${user.country || 'N/A'}</p>
          <p><strong>Phone:</strong> ${user.countryCode}${user.number || 'N/A'}</p>
          <a href="chat.html?id=${user._id}" style="display:inline-block;margin-top:18px;padding:10px 18px;background:#007bff;color:#fff;border-radius:8px;text-decoration:none;font-weight:500;">Chat</a>
        `;
        popupBox.style.display = 'flex';
      }

      document.getElementById('closePopup').onclick = function() {
        document.getElementById('popupBox').style.display = 'none';
      };

      function userTemplate(user) {
        return `
                      <li class="user">
                        <div class="userInfo" id="${user._id}">
                          <a href="chat.html?id=${user._id}">${user.name}</a>
                        </div>
                      </li>
                    `;
      }

      async function fetchConversation() {
        let userId = localStorage.getItem("userId");
        if (!userId) {
          return;
        }
        try {
          let conversations = await fetch(
            `http://localhost:3000/api/conversations/all/${userId}`
          );
          conversations = await conversations.json();
          let userNamesSet = new Set();
          let userHtml = "";
          for (const conversation of conversations.conversation) {
            let user;
            for (let key in conversation) {
              if (userId !== conversation[key] && key !== "_id")
                user = conversation[key];
            }
            let con = await fetch(
              `http://localhost:3000/api/users/get-user-id/${user}`
            );
            con = await con.json();
            if (!userNamesSet.has(con.name)) {
              userNamesSet.add(con.name);
              userHtml += userTemplate(con);
            }
          }
          let userList = document.getElementById("searchedUsers");
          userList.innerHTML = userHtml;
        } catch (error) {
          console.error("Error fetching conversations:", error);
        }
      }

      fetchConversation();

      document.querySelector("button").addEventListener("click", () => {
        let query = searchUserInput.value.trim();
        if (query) {
          fetchUser(query);
          searchUserInput.value = "";
        }
      });
    </script>
  </body>
</html>
